<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <title>EMS Protocols & Med Doses</title>
  <style>
    :root { --bg:#0b0d10; --card:#141820; --muted:#a7b0be; --text:#e6eef8; --accent:#5eead4; --accent2:#93c5fd; }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;background:var(--bg);color:var(--text)}
    header{position:sticky;top:0;background:linear-gradient(180deg,rgba(20,24,32,.98),rgba(20,24,32,.9));backdrop-filter:saturate(120%) blur(6px);z-index:20;border-bottom:1px solid rgba(255,255,255,.06)}
    .wrap{max-width:900px;margin:0 auto;padding:16px}
    .title{font-weight:700;letter-spacing:.2px;font-size:18px}
    .searchbar{display:flex;gap:10px;margin-top:10px}
    input[type="search"],input[type="text"],input[type="number"],select{width:100%;padding:14px 14px;border-radius:14px;border:1px solid rgba(255,255,255,.1);background:#0f131a;color:var(--text);outline:none}
    input::placeholder{color:#8a94a7}
    .tabs{display:flex;gap:8px;margin-top:12px}
    .tab{flex:1;text-align:center;padding:10px 12px;border-radius:12px;background:#0f131a;border:1px solid rgba(255,255,255,.08);cursor:pointer}
    .tab.active{background:linear-gradient(180deg,#0f131a,#101725);border-color:rgba(148,163,184,.25);box-shadow:0 1px 0 rgba(255,255,255,.04) inset, 0 0 0 2px rgba(94,234,212,.15)}
    .hint{color:var(--muted);font-size:12px;margin-top:6px}
    .grid{display:grid;grid-template-columns:1fr;gap:12px;margin-top:14px}
    @media(min-width:720px){.grid{grid-template-columns:1fr 1fr}}
    .card{background:var(--card);border:1px solid rgba(255,255,255,.06);border-radius:16px;padding:14px}
    .card h3{margin:0 0 6px;font-size:16px}
    .badge{display:inline-block;padding:2px 8px;border-radius:999px;background:rgba(147,197,253,.12);color:var(--accent2);font-size:11px;margin-right:6px;border:1px solid rgba(147,197,253,.25)}
    .tag{display:inline-block;margin:6px 6px 0 0;padding:4px 8px;border-radius:10px;background:#0f131a;border:1px dashed rgba(255,255,255,.12);color:#b6c2d6;font-size:11px}
    .row{display:flex;gap:10px}
    .row>*{flex:1}
    .btn{padding:12px 14px;border-radius:12px;border:1px solid rgba(255,255,255,.12);background:#0f131a;color:var(--text);cursor:pointer}
    .btn.primary{background:linear-gradient(180deg,#0f131a,#132036);border-color:rgba(94,234,212,.35)}
    .pill{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border:1px solid rgba(255,255,255,.12);border-radius:999px;font-size:12px}
    .k{display:inline-block;min-width:1.4em;text-align:center;background:rgba(94,234,212,.15);color:#88ffeb;border:1px solid rgba(94,234,212,.35);border-radius:6px;padding:1px 4px;margin-right:4px}
    mark{background:rgba(94,234,212,.2);padding:0 2px;border-radius:4px}
    .footer{color:#7f8aa3;font-size:12px;margin:18px 0}
    .hidden{display:none}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace;font-size:12px}
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <div class="title">ðŸš‘ EMS Protocols & Doses</div>
      <div class="searchbar">
        <input id="q" type="search" inputmode="search" autocomplete="off" placeholder="Search protocols, meds, keywords (e.g., 'adult airway', 'ketamine', 'brady')" />
      </div>
      <div class="tabs">
        <button class="tab active" data-tab="protocols">Protocols</button>
        <button class="tab" data-tab="meds">Meds</button>
        <button class="tab" data-tab="calc">Dose Calc</button>
      </div>
      <div class="hint">Tip: Add this page to your home screen for 1â€‘tap access. Data never leaves your device.</div>
    </div>
  </header>

  <main class="wrap">
    <!-- Protocols -->
    <section id="panel-protocols" class="panel">
      <div id="protocols" class="grid"></div>
    </section>

    <!-- Meds -->
    <section id="panel-meds" class="panel hidden">
      <div id="meds" class="grid"></div>
    </section>

    <!-- Calculator -->
    <section id="panel-calc" class="panel hidden">
      <div class="card">
        <h3>Weightâ€‘Based Dose Calculator</h3>
        <div class="row">
          <div>
            <label class="hint">Medication</label>
            <select id="calc-med"></select>
          </div>
          <div>
            <label class="hint">Weight</label>
            <div class="row">
              <input id="wt" type="number" inputmode="decimal" placeholder="e.g. 70" />
              <select id="unit"><option value="kg">kg</option><option value="lb">lb</option></select>
            </div>
          </div>
        </div>
        <div class="row" style="margin-top:10px">
          <div>
            <label class="hint">mg/kg (override)</label>
            <input id="mgkg" type="number" inputmode="decimal" placeholder="auto from med" />
          </div>
          <div>
            <label class="hint">Max dose mg</label>
            <input id="maxmg" type="number" inputmode="decimal" placeholder="auto from med" />
          </div>
        </div>
        <div class="row" style="margin-top:10px">
          <div>
            <label class="hint">Concentration (mg/mL)</label>
            <input id="conc" type="number" inputmode="decimal" placeholder="e.g. 10" />
          </div>
          <div>
            <label class="hint">Route</label>
            <input id="route" type="text" placeholder="auto from med" />
          </div>
        </div>
        <div style="margin-top:12px" class="row">
          <button id="calc" class="btn primary">Calculate</button>
          <button id="reset" class="btn">Reset</button>
        </div>
        <div id="result" class="mono" style="margin-top:12px"></div>
      </div>

      <div class="card">
        <h3>Standard Dose â†’ Volume</h3>
        <p class="hint">Formula: (Dose ordered / Dose on hand) Ã— Volume on hand = mL to draw. Or use concentration directly.</p>
        <div class="row">
          <div>
            <label class="hint">Dose ordered</label>
            <input id="std-dose-ordered" type="number" inputmode="decimal" placeholder="e.g. 5" />
          </div>
          <div>
            <label class="hint">Dose on hand</label>
            <input id="std-dose-onhand" type="number" inputmode="decimal" placeholder="e.g. 10" />
          </div>
          <div>
            <label class="hint">Volume on hand (mL)</label>
            <input id="std-vol-onhand" type="number" inputmode="decimal" placeholder="e.g. 1" />
          </div>
        </div>
        <div class="row" style="margin-top:10px">
          <div>
            <label class="hint">OR: Concentration (mg/mL)</label>
            <input id="std-conc" type="number" inputmode="decimal" placeholder="e.g. 10" />
          </div>
          <div>
            <label class="hint">Result</label>
            <div id="std-result" class="mono" style="padding:12px;border:1px solid rgba(255,255,255,.12);border-radius:12px;min-height:44px"></div>
          </div>
        </div>
        <div style="margin-top:12px" class="row">
          <button id="std-calc" class="btn primary">Calculate</button>
          <button id="std-reset" class="btn">Reset</button>
        </div>
      </div>

      <div class="card">
        <h3>IV Infusion (mcg/kg/min â†’ gtts/min)</h3>
        <p class="hint">Enter ordered dose, patient weight, drug in bag, bag volume, and drip set. Weâ€™ll compute mL/hr and gtts/min.</p>
        <div class="row">
          <div>
            <label class="hint">Ordered (mcg/kg/min)</label>
            <input id="iv-ordered" type="number" inputmode="decimal" placeholder="e.g. 5" />
          </div>
          <div>
            <label class="hint">Weight</label>
            <div class="row">
              <input id="iv-wt" type="number" inputmode="decimal" placeholder="e.g. 70" />
              <select id="iv-unit"><option value="kg">kg</option><option value="lb">lb</option></select>
            </div>
          </div>
        </div>
        <div class="row" style="margin-top:10px">
          <div>
            <label class="hint">Drug in bag (mg)</label>
            <input id="iv-bagmg" type="number" inputmode="decimal" placeholder="e.g. 400" />
          </div>
          <div>
            <label class="hint">Bag volume (mL)</label>
            <input id="iv-bagvol" type="number" inputmode="decimal" placeholder="e.g. 250" />
          </div>
          <div>
            <label class="hint">Drip set (gtt/mL)</label>
            <input id="iv-dripset" type="number" inputmode="decimal" placeholder="10 / 15 / 20 / 60" />
          </div>
        </div>
        <div style="margin-top:12px" class="row">
          <button id="iv-calc" class="btn primary">Calculate</button>
          <button id="iv-reset" class="btn">Reset</button>
        </div>
        <div id="iv-result" class="mono" style="margin-top:12px"></div>
      </div>

      <div class="card">
        <h3>Manual Drip Timing</h3>
        <p class="hint">Target drops/min â†’ drops per 10 seconds (Ã·6).</p>
        <div class="row">
          <div>
            <label class="hint">Target (gtts/min)</label>
            <input id="md-target" type="number" inputmode="decimal" placeholder="e.g. 30" />
          </div>
          <div>
            <label class="hint">Result</label>
            <div id="md-result" class="mono" style="padding:12px;border:1px solid rgba(255,255,255,.12);border-radius:12px;min-height:44px"></div>
          </div>
        </div>
        <div style="margin-top:12px" class="row">
          <button id="md-calc" class="btn primary">Calculate</button>
          <button id="md-reset" class="btn">Reset</button>
        </div>
      </div>

      <div class="card">
        <h3>Fluid Over Time</h3>
        <p class="hint">Given volume, drip set, and time, compute gtts/min and mL/hr.</p>
        <div class="row">
          <div>
            <label class="hint">Volume (mL)</label>
            <input id="fo-volume" type="number" inputmode="decimal" placeholder="e.g. 1000" />
          </div>
          <div>
            <label class="hint">Drip set (gtt/mL)</label>
            <input id="fo-dripset" type="number" inputmode="decimal" placeholder="10 / 15 / 20 / 60" />
          </div>
          <div>
            <label class="hint">Time (min)</label>
            <input id="fo-time" type="number" inputmode="decimal" placeholder="e.g. 60" />
          </div>
        </div>
        <div style="margin-top:12px" class="row">
          <button id="fo-calc" class="btn primary">Calculate</button>
          <button id="fo-reset" class="btn">Reset</button>
        </div>
        <div id="fo-result" class="mono" style="margin-top:12px"></div>
      </div>

      <div class="card">
        <h3>APGAR Calculator</h3>
        <div class="row">
          <div>
            <label class="hint">Appearance</label>
            <select id="apgar-a"><option value="0">0: Blue/Pale</option><option value="1">1: Body pink, limbs blue</option><option value="2">2: Completely pink</option></select>
          </div>
          <div>
            <label class="hint">Pulse</label>
            <select id="apgar-p"><option value="0">0: Absent</option><option value="1">1: &lt;100</option><option value="2">2: â‰¥100</option></select>
          </div>
          <div>
            <label class="hint">Grimace</label>
            <select id="apgar-g"><option value="0">0: No response</option><option value="1">1: Grimace</option><option value="2">2: Cough/Sneeze/Cry</option></select>
          </div>
          <div>
            <label class="hint">Activity</label>
            <select id="apgar-ac"><option value="0">0: Limp</option><option value="1">1: Some flexion</option><option value="2">2: Active</option></select>
          </div>
          <div>
            <label class="hint">Respiration</label>
            <select id="apgar-r"><option value="0">0: Absent</option><option value="1">1: Slow/Irregular</option><option value="2">2: Good cry</option></select>
          </div>
        </div>
        <div style="margin-top:12px" class="row">
          <button id="apgar-calc" class="btn primary">Calculate</button>
          <button id="apgar-reset" class="btn">Reset</button>
        </div>
        <div id="apgar-result" class="mono" style="margin-top:12px"></div>
      </div>

      <div class="card">
        <h3>GCS Calculator</h3>
        <div class="row">
          <div>
            <label class="hint">Eye (E)</label>
            <select id="gcs-e"><option value="1">1: None</option><option value="2">2: To pain</option><option value="3">3: To voice</option><option value="4" selected>4: Spontaneous</option></select>
          </div>
          <div>
            <label class="hint">Verbal (V)</label>
            <select id="gcs-v"><option value="1">1: None</option><option value="2">2: Incomprehensible</option><option value="3">3: Inappropriate</option><option value="4">4: Confused</option><option value="5" selected>5: Oriented</option></select>
          </div>
          <div>
            <label class="hint">Motor (M)</label>
            <select id="gcs-m"><option value="1">1: None</option><option value="2">2: Extensor</option><option value="3">3: Flexor</option><option value="4">4: Withdraws</option><option value="5">5: Localizes</option><option value="6" selected>6: Obeys</option></select>
          </div>
        </div>
        <div style="margin-top:12px" class="row">
          <button id="gcs-calc" class="btn primary">Calculate</button>
          <button id="gcs-reset" class="btn">Reset</button>
        </div>
        <div id="gcs-result" class="mono" style="margin-top:12px"></div>
      </div>

      <div class="card">
        <h3>Oxygen Duration</h3>
        <div class="row">
          <div>
            <label class="hint">Cylinder</label>
            <select id="o2-cylinder">
              <option value="0.16">D (0.16)</option>
              <option value="0.28" selected>E (0.28)</option>
              <option value="1.56">M (1.56)</option>
              <option value="2.41">G (2.41)</option>
              <option value="3.14">H (3.14)</option>
            </select>
          </div>
          <div>
            <label class="hint">Pressure (psi)</label>
            <input id="o2-psi" type="number" inputmode="decimal" placeholder="e.g. 2000" />
          </div>
          <div>
            <label class="hint">Residual (psi)</label>
            <input id="o2-res" type="number" inputmode="decimal" value="200" />
          </div>
          <div>
            <label class="hint">Flow (L/min)</label>
            <input id="o2-flow" type="number" inputmode="decimal" placeholder="e.g. 15" />
          </div>
        </div>
        <div style="margin-top:12px" class="row">
          <button id="o2-calc" class="btn primary">Calculate</button>
          <button id="o2-reset" class="btn">Reset</button>
        </div>
        <div id="o2-result" class="mono" style="margin-top:12px"></div>
      </div>

      <div class="card">
        <h3>Vent Settings (IBW & TV)</h3>
        <p class="hint">Quick tidal volume planner using IBW (Devine). Always follow clinical judgment & protocols.</p>
        <div class="row">
          <div>
            <label class="hint">Sex</label>
            <select id="vent-sex"><option value="male">Male</option><option value="female">Female</option></select>
          </div>
          <div>
            <label class="hint">Height</label>
            <div class="row">
              <input id="vent-height" type="number" inputmode="decimal" placeholder="e.g. 70" />
              <select id="vent-hunit"><option value="in">in</option><option value="cm">cm</option></select>
            </div>
          </div>
        </div>
        <div style="margin-top:12px" class="row">
          <button id="vent-calc" class="btn primary">Calculate</button>
          <button id="vent-reset" class="btn">Reset</button>
        </div>
        <div id="vent-result" class="mono" style="margin-top:12px"></div>
      </div>

      <div class="card">
        <h3>Import / Export Your Data</h3>
        <p class="hint">Your protocols & meds are stored locally in your browser. You can edit the JSON below or export/import a file.</p>
        <div class="row">
          <button id="save-json" class="btn">Save to Browser</button>
          <button id="export-json" class="btn">Export .json</button>
          <input id="import-file" type="file" accept="application/json" class="btn" />
        </div>
        <textarea id="json" rows="10" style="width:100%;margin-top:10px;border-radius:12px;padding:12px;background:#0f131a;color:var(--text);border:1px solid rgba(255,255,255,.12)"></textarea>
      </div>
    </section>

    <div class="footer">Made for quick, offlineâ€‘friendly reference. Always follow your serviceâ€™s latest approved protocols.</div>
  </main>

  <script>
  // --- Simple client-side store ---
  const KEY = 'ems-protocols-v1';
  const $ = sel => document.querySelector(sel);
  const $$ = sel => Array.from(document.querySelectorAll(sel));

  const SAMPLE = {
    protocols: [
      {
        id: 'adult-airway',
        title: 'Adult Airway (Intubation First Pass, Facilitated if needed)',
        summary: 'Oro/Nasotracheal; if failed first attempt â†’ consider ketamineâ€‘assisted intubation; confirm with EtCOâ‚‚ + second method; fallback SGA â†’ needle cric/BVM.',
        steps: [
          'Assess: unresponsive/apneic, gag, predicted difficulty; preoxygenate; suction as needed.',
          'Prepare: equipment check (laryngoscope/video, ET sizes, SGA backup, suction, BVM, capnography).',
          'Attempt orotracheal or nasotracheal intubation (1st pass).',
          'If unsuccessful: consider facilitated intubation (ketamine 2 mg/kg IV/IO).',
          'If still unsuccessful: place supraglottic airway; if failure â†’ needle cricothyrotomy and/or BVM.',
          'If intubated: confirm placement with EtCOâ‚‚ and an additional method (auscultation, CXR if available), secure tube.',
          'Reassess ventilation/oxygenation and document time, size, depth, confirmation method.'
        ],
        tags: ['airway','adult','intubation','ketamine','etco2','sgA','cric'],
      },
      {
        id: 'bradycardia-adult',
        title: 'Bradycardia â€“ Adult (Symptomatic)',
        summary: 'Atropine 1 mg IV q3-5min (max 3 mg); if ineffective â†’ TCP / dopamine infusion 5â€“20 mcg/kg/min; consider reversible causes.',
        steps: [
          'ABC, oxygen, monitor, IV/IO access, 12-lead if feasible.',
          'Atropine 1 mg IV q3â€“5min, max total 3 mg.',
          'If ineffective: transcutaneous pacing; analgesia/sedation as needed.',
          'Alternative/bridge: dopamine infusion 5â€“20 mcg/kg/min titrate to response.',
          'Treat reversible causes (hypoxia, hypothermia, hyperkalemia, toxins).'
        ],
        tags: ['cardiac','adult','atropine','dopamine','pacing']
      }
    ],
    meds: [
      { name: 'Ketamine', alias:['ket'], default_mgkg: 2, route: 'IV/IO', max_mg: 200, notes: 'For facilitated intubation; consider lower dose if elderly or hypotensive.' },
      { name: 'Atropine', alias:['atrop'], default_mgkg: 0.02, route: 'IV/IO', max_mg: 3, notes: 'Adult fixed dose often 1 mg; peds weight-based.' },
      { name: 'Epinephrine 1:1,000', alias:['epi 1:1k'], default_mgkg: 0.01, route: 'IM', max_mg: 0.5, notes: 'Anaphylaxis IM; check local protocol.' }
    ]
  };

  function load(){
    try{ return JSON.parse(localStorage.getItem(KEY)) || SAMPLE }catch(e){ return SAMPLE }
  }
  function save(data){ localStorage.setItem(KEY, JSON.stringify(data)); }

  let state = load();

  // --- Rendering ---
  const protocolsEl = $('#protocols');
  const medsEl = $('#meds');
  const jsonEl = $('#json');

  function highlight(text, terms){
    if(!terms.length) return text;
    let t = text;
    terms.forEach(w=>{ const re = new RegExp('('+escapeRegExp(w)+')','ig'); t = t.replace(re,'<mark>$1</mark>') });
    return t;
  }
  function escapeRegExp(s){ return s.replace(/[.*+?^${}()|[\]\\]/g, '\\$&') }

  function renderProtocols(filterTerms=[]){
    const items = state.protocols.filter(p=> matchItem(p, filterTerms));
    protocolsEl.innerHTML = items.map(p=> `
      <div class="card">
        <h3>${highlight(p.title, filterTerms)}</h3>
        <div class="hint">${highlight(p.summary, filterTerms)}</div>
        <div style="margin-top:8px">
          ${p.steps.map((s,i)=>`<div><span class="k">${i+1}</span> ${highlight(s, filterTerms)}</div>`).join('')}
        </div>
        <div>${p.tags.map(t=>`<span class="tag">${t}</span>`).join('')}</div>
      </div>
    `).join('') || emptyState('No protocol matches');
  }

  function renderMeds(filterTerms=[]){
    const items = state.meds.filter(m=> matchItem(m, filterTerms));
    medsEl.innerHTML = items.map(m=> `
      <div class="card">
        <h3>${highlight(m.name, filterTerms)} <span class="badge">${m.route}</span></h3>
        <div class="hint">Default: ${m.default_mgkg} mg/kg â€¢ Max ${m.max_mg} mg</div>
        <div class="hint">${highlight(m.notes||'', filterTerms)}</div>
        <div style="margin-top:8px" class="row">
          <button class="btn" onclick="loadIntoCalc('${m.name.replace(/'/g,"&#39;")}')">Send to Calculator</button>
          <button class="btn" onclick="copyText('${m.name.replace(/'/g,"&#39;")}: ${m.default_mgkg} mg/kg (max ${m.max_mg} mg) ${m.route}')">Copy</button>
        </div>
      </div>
    `).join('') || emptyState('No medication matches');
  }

  function emptyState(msg){
    return `<div class="card">${msg}</div>`;
  }

  function matchItem(obj, terms){
    if(!terms.length) return true;
    const hay = (Object.values(obj).join(' ') + ' ' + (obj.tags||[]).join(' ')).toLowerCase();
    return terms.every(t => hay.includes(t));
  }

  function renderAll(terms){
    renderProtocols(terms);
    renderMeds(terms);
    renderCalcOptions();
    jsonEl.value = JSON.stringify(state, null, 2);
  }

  // --- Search ---
  const q = $('#q');
  let deb;
  q.addEventListener('input', e=>{
    clearTimeout(deb);
    deb = setTimeout(()=>{
      const terms = q.value.trim().toLowerCase().split(/\s+/).filter(Boolean);
      renderAll(terms);
    }, 80);
  });

  // --- Tabs ---
  $$('.tab').forEach(btn=> btn.addEventListener('click', ()=>{
    $$('.tab').forEach(b=> b.classList.remove('active'));
    btn.classList.add('active');
    const tab = btn.dataset.tab;
    $$('.panel').forEach(p=> p.classList.add('hidden'));
    $('#panel-'+tab).classList.remove('hidden');
  }));

  // --- Calc ---
  function kg(val, unit){ return unit==='lb' ? (val/2.20462) : val }
  function renderCalcOptions(){
    const sel = $('#calc-med');
    sel.innerHTML = '<option value="">â€” choose â€”</option>' + state.meds.map(m=>`<option value="${m.name}">${m.name}</option>`).join('');
  }
  function loadIntoCalc(name){
    const m = state.meds.find(x=>x.name===name);
    if(!m) return;
    $('#calc-med').value = m.name;
    $('#mgkg').value = m.default_mgkg;
    $('#maxmg').value = m.max_mg;
    $('#route').value = m.route||'';
    document.querySelector('[data-tab="calc"]').click();
  }
  window.loadIntoCalc = loadIntoCalc;

  $('#calc').addEventListener('click', ()=>{
    const medName = $('#calc-med').value;
    const m = state.meds.find(x=>x.name===medName);
    if(!m){ $('#result').innerHTML = 'Select a medication.'; return }
    const wt = parseFloat($('#wt').value||'0');
    const unit = $('#unit').value;
    const mgkg = parseFloat($('#mgkg').value||m.default_mgkg||0);
    const maxmg = parseFloat($('#maxmg').value||m.max_mg||Infinity);
    const conc = parseFloat($('#conc').value||'0');
    if(!wt || !mgkg){ $('#result').innerHTML = 'Enter weight and mg/kg.'; return }
    const weightKg = kg(wt, unit);
    let dose = weightKg * mgkg; // mg
    if(isFinite(maxmg)) dose = Math.min(dose, maxmg);
    const mL = conc ? (dose/conc) : null;
    $('#result').innerHTML = `
      <div>Medication: <b>${medName}</b> (${m?.route||$('#route').value||''})</div>
      <div>Weight used: <b>${weightKg.toFixed(1)} kg</b> (${unit==='lb'? wt+' lb':''})</div>
      <div>Total dose: <b>${dose.toFixed(1)} mg</b>${isFinite(maxmg)?` (max ${maxmg} mg)`:''}</div>
      ${mL!==null?`<div>Volume to draw: <b>${mL.toFixed(2)} mL</b> @ ${conc} mg/mL</div>`:''}
    `;
  });

  $('#reset').addEventListener('click', ()=>{
    ['wt','mgkg','maxmg','conc','route'].forEach(id=> $('#'+id).value='');
    $('#calc-med').value='';
    $('#result').innerHTML='';
  });

  // --- Extra calculators logic ---
  function toKg(val, unit){ return unit==='lb' ? (val/2.20462) : val }
  function fmt(n, d=1){ if(!isFinite(n)) return 'â€”'; return Number(n).toFixed(d) }
  function hhmm(min){ if(!isFinite(min)) return 'â€”'; const h=Math.floor(min/60), m=Math.round(min%60); return `${h}h ${m}m` }

  // Standard Dose â†’ Volume
  $('#std-calc').addEventListener('click', ()=>{
    const ordered = parseFloat($('#std-dose-ordered').value||'0');
    const onhand = parseFloat($('#std-dose-onhand').value||'0');
    const vol = parseFloat($('#std-vol-onhand').value||'0');
    const conc = parseFloat($('#std-conc').value||'0');
    let mL = NaN;
    if(ordered && onhand && vol){ mL = (ordered/onhand)*vol }
    else if(ordered && conc){ mL = ordered/conc }
    const txt = isFinite(mL) ? `Draw: **${fmt(mL,2)} mL**` : 'Enter ordered + onâ€‘hand + volume, or ordered + concentration.';
    $('#std-result').innerHTML = txt;
  });
  $('#std-reset').addEventListener('click', ()=>{ ['std-dose-ordered','std-dose-onhand','std-vol-onhand','std-conc'].forEach(id=> $('#'+id).value=''); $('#std-result').innerHTML=''; });

  // IV Infusion gtts/min
  $('#iv-calc').addEventListener('click', ()=>{
    const ordered = parseFloat($('#iv-ordered').value||'0'); // mcg/kg/min
    let wt = parseFloat($('#iv-wt').value||'0');
    wt = toKg(wt, $('#iv-unit').value);
    const bagmg = parseFloat($('#iv-bagmg').value||'0'); // mg
    const bagvol = parseFloat($('#iv-bagvol').value||'0'); // mL
    const drip = parseFloat($('#iv-dripset').value||'0'); // gtt/mL
    if(!(ordered&&wt&&bagmg&&bagvol&&drip)){ $('#iv-result').innerHTML='Enter all fields.'; return }
    const mgPerMl = bagmg / bagvol; // mg/mL
    const mgPerHr = (ordered * wt * 60) / 1000; // mcgâ†’mg
    const mLhr = mgPerHr / mgPerMl;
    const gttsMin = (mLhr * drip) / 60;
    $('#iv-result').innerHTML = `mL/hr: <b>${fmt(mLhr,1)}</b> â€¢ gtts/min: <b>${Math.round(gttsMin)}</b>`;
  });
  $('#iv-reset').addEventListener('click', ()=>{ ['iv-ordered','iv-wt','iv-bagmg','iv-bagvol','iv-dripset'].forEach(id=> $('#'+id).value=''); $('#iv-result').innerHTML=''; });

  // Manual Drip Timing
  $('#md-calc').addEventListener('click', ()=>{
    const target = parseFloat($('#md-target').value||'0');
    if(!target){ $('#md-result').innerHTML='Enter a target gtts/min.'; return }
    const per10 = target/6;
    $('#md-result').innerHTML = `Aim ~<b>${Math.round(per10)}</b> gtts every 10 s (exact: ${fmt(per10,1)}).`;
  });
  $('#md-reset').addEventListener('click', ()=>{ $('#md-target').value=''; $('#md-result').innerHTML=''; });

  // Fluid Over Time
  $('#fo-calc').addEventListener('click', ()=>{
    const vol = parseFloat($('#fo-volume').value||'0');
    const drip = parseFloat($('#fo-dripset').value||'0');
    const time = parseFloat($('#fo-time').value||'0');
    if(!(vol&&drip&&time)){ $('#fo-result').innerHTML='Enter volume, drip set, and time.'; return }
    const gttsMin = (vol * drip) / time;
    const mLhr = (vol / time) * 60;
    $('#fo-result').innerHTML = `gtts/min: <b>${Math.round(gttsMin)}</b> â€¢ mL/hr: <b>${fmt(mLhr,0)}</b>`;
  });
  $('#fo-reset').addEventListener('click', ()=>{ ['fo-volume','fo-dripset','fo-time'].forEach(id=> $('#'+id).value=''); $('#fo-result').innerHTML=''; });

  // APGAR
  $('#apgar-calc').addEventListener('click', ()=>{
    const a = parseInt($('#apgar-a').value); const p = parseInt($('#apgar-p').value); const g = parseInt($('#apgar-g').value); const ac = parseInt($('#apgar-ac').value); const r = parseInt($('#apgar-r').value);
    const total = a+p+g+ac+r;
    let cat = total>=7? 'Normal (7â€“10)' : total>=4? 'Moderate (4â€“6)' : 'Low (0â€“3)';
    $('#apgar-result').innerHTML = `Score: <b>${total}</b> â€¢ ${cat}`;
  });
  $('#apgar-reset').addEventListener('click', ()=>{ ['apgar-a','apgar-p','apgar-g','apgar-ac','apgar-r'].forEach(id=> $('#'+id).selectedIndex=0); $('#apgar-result').innerHTML=''; });

  // GCS
  $('#gcs-calc').addEventListener('click', ()=>{
    const e = parseInt($('#gcs-e').value); const v = parseInt($('#gcs-v').value); const m = parseInt($('#gcs-m').value);
    const total = e+v+m;
    $('#gcs-result').innerHTML = `E${e} V${v} M${m} â€¢ Total: <b>${total}</b>`;
  });
  '#gcs-reset' in window || (window['#gcs-reset']=null);
  $('#gcs-reset').addEventListener('click', ()=>{ $('#gcs-e').selectedIndex=3; $('#gcs-v').selectedIndex=4; $('#gcs-m').selectedIndex=5; $('#gcs-result').innerHTML=''; });

  // Oxygen Duration
  $('#o2-calc').addEventListener('click', ()=>{
    const k = parseFloat($('#o2-cylinder').value||'0');
    const psi = parseFloat($('#o2-psi').value||'0');
    const res = parseFloat($('#o2-res').value||'0');
    const flow = parseFloat($('#o2-flow').value||'0');
    if(!(k&&psi&&flow)){ $('#o2-result').innerHTML='Enter cylinder, pressure, and flow.'; return }
    const min = ((psi - res) * k) / flow;
    $('#o2-result').innerHTML = `Duration: <b>${fmt(min,0)} min</b> (~${hhmm(min)})`;
  });
  $('#o2-reset').addEventListener('click', ()=>{ ['o2-psi','o2-flow'].forEach(id=> $('#'+id).value=''); $('#o2-res').value='200'; $('#o2-result').innerHTML=''; });

  // Vent Settings (IBW & TV)
  function inchesFrom(val, unit){ return unit==='cm' ? (val/2.54) : val }
  function ibwKg(sex, inches){ const over5ft = Math.max(0, inches - 60); return (sex==='male' ? 50 : 45.5) + 2.3*over5ft }
  $('#vent-calc').addEventListener('click', ()=>{
    const sex = $('#vent-sex').value;
    const h = parseFloat($('#vent-height').value||'0');
    const unit = $('#vent-hunit').value;
    if(!(sex&&h)){ $('#vent-result').innerHTML='Enter sex and height.'; return }
    const inches = inchesFrom(h, unit);
    const ibw = ibwKg(sex, inches);
    const tv6 = ibw*6, tv7 = ibw*7, tv8 = ibw*8; // mL
    $('#vent-result').innerHTML = `IBW: <b>${fmt(ibw,1)} kg</b> â€¢ TV @6: <b>${fmt(tv6,0)} mL</b> â€¢ @7: <b>${fmt(tv7,0)} mL</b> â€¢ @8: <b>${fmt(tv8,0)} mL</b>`;
  });
  $('#vent-reset').addEventListener('click', ()=>{ $('#vent-height').value=''; $('#vent-sex').selectedIndex=0; $('#vent-hunit').selectedIndex=0; $('#vent-result').innerHTML=''; });

  // --- Import/Export ---
  $('#save-json').addEventListener('click', ()=>{ try{ state = JSON.parse(jsonEl.value); save(state); alert('Saved locally.'); renderAll(q.value.trim().toLowerCase().split(/\s+/).filter(Boolean)); }catch(e){ alert('Invalid JSON') } });
  $('#export-json').addEventListener('click', ()=>{
    const blob = new Blob([JSON.stringify(state,null,2)], {type:'application/json'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'ems-protocols.json';
    a.click();
  });
  $('#import-file').addEventListener('change', async (e)=>{
    const file = e.target.files[0]; if(!file) return;
    const txt = await file.text();
    try{ state = JSON.parse(txt); save(state); jsonEl.value = JSON.stringify(state,null,2); renderAll(q.value.trim().toLowerCase().split(/\s+/).filter(Boolean)); alert('Imported and saved.'); }
    catch(err){ alert('Invalid JSON file.'); }
  });

  function copyText(t){ navigator.clipboard?.writeText(t); }
  window.copyText = copyText;

  // Init
  renderAll([]);
  </script>
</body>
</html>
