<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <title>EMS Protocols & Med Doses</title>
  <style>
    :root { --bg:#0b0d10; --card:#141820; --muted:#a7b0be; --text:#e6eef8; --accent:#5eead4; --accent2:#93c5fd; }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;background:var(--bg);color:var(--text)}
    header{position:sticky;top:0;background:linear-gradient(180deg,rgba(20,24,32,.98),rgba(20,24,32,.9));backdrop-filter:saturate(120%) blur(6px);z-index:20;border-bottom:1px solid rgba(255,255,255,.06)}
    .wrap{max-width:1024px;margin:0 auto;padding:16px}
    .title{font-weight:700;letter-spacing:.2px;font-size:18px}
    .bar{display:grid;grid-template-columns:1fr;gap:10px;margin-top:10px}
    @media(min-width:860px){.bar{grid-template-columns:1fr 1fr}}
    input[type="search"],input[type="text"],input[type="number"],select,textarea{width:100%;padding:14px 14px;border-radius:14px;border:1px solid rgba(255,255,255,.1);background:#0f131a;color:var(--text);outline:none}
    input::placeholder{color:#8a94a7}
    .tabs{display:flex;gap:8px;margin-top:12px}
    .tab{flex:1;text-align:center;padding:10px 12px;border-radius:12px;background:#0f131a;border:1px solid rgba(255,255,255,.08);cursor:pointer}
    .tab.active{background:linear-gradient(180deg,#0f131a,#101725);border-color:rgba(148,163,184,.25);box-shadow:0 1px 0 rgba(255,255,255,.04) inset, 0 0 0 2px rgba(94,234,212,.15)}
    .hint{color:var(--muted);font-size:12px;margin-top:6px}
    .grid{display:grid;grid-template-columns:1fr;gap:12px;margin-top:14px}
    @media(min-width:720px){.grid{grid-template-columns:1fr 1fr}}
    .card{background:var(--card);border:1px solid rgba(255,255,255,.06);border-radius:16px;padding:14px}
    .card h3{margin:0 0 6px;font-size:16px}
    .badge{display:inline-block;padding:2px 8px;border-radius:999px;background:rgba(147,197,253,.12);color:var(--accent2);font-size:11px;margin-right:6px;border:1px solid rgba(147,197,253,.25)}
    .tag{display:inline-block;margin:6px 6px 0 0;padding:4px 8px;border-radius:10px;background:#0f131a;border:1px dashed rgba(255,255,255,.12);color:#b6c2d6;font-size:11px}
    .row{display:flex;gap:10px}
    .row>*{flex:1}
    .btn{padding:12px 14px;border-radius:12px;border:1px solid rgba(255,255,255,.12);background:#0f131a;color:var(--text);cursor:pointer}
    .btn.primary{background:linear-gradient(180deg,#0f131a,#132036);border-color:rgba(94,234,212,.35)}
    .btn.danger{border-color:rgba(239,68,68,.5)}
    .pill{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border:1px solid rgba(255,255,255,.12);border-radius:999px;font-size:12px}
    .k{display:inline-block;min-width:1.4em;text-align:center;background:rgba(94,234,212,.15);color:#88ffeb;border:1px solid rgba(94,234,212,.35);border-radius:6px;padding:1px 4px;margin-right:4px}
    mark{background:rgba(94,234,212,.2);padding:0 2px;border-radius:4px}
    .footer{color:#7f8aa3;font-size:12px;margin:18px 0}
    .hidden{display:none}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace;font-size:12px}
    .toolbar{display:flex;gap:8px;flex-wrap:wrap}
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <div class="title">ðŸš‘ EMS Protocols & Doses</div>
      <div class="bar">
        <div class="toolbar">
          <select id="service-select" title="Ambulance Service"></select>
          <button id="add-service" class="btn">New Service</button>
          <button id="rename-service" class="btn">Rename</button>
          <button id="duplicate-service" class="btn">Duplicate</button>
          <button id="delete-service" class="btn danger">Delete</button>
        </div>
        <input id="q" type="search" inputmode="search" autocomplete="off" placeholder="Search protocols, meds, keywords (e.g., 'adult airway', 'ketamine', 'brady')" />
      </div>
      <div class="tabs">
        <button class="tab active" data-tab="protocols">Protocols</button>
        <button class="tab" data-tab="meds">Meds</button>
        <button class="tab" data-tab="calc">Dose Calc</button>
      </div>
      <div class="hint">Select an Ambulance Service. Data stays on-device; use Import/Export to share or back up.</div>
    </div>
  </header>

  <main class="wrap">
    <!-- Protocols -->
    <section id="panel-protocols" class="panel">
      <div id="protocols" class="grid"></div>
    </section>

    <!-- Meds -->
    <section id="panel-meds" class="panel hidden">
      <div id="meds" class="grid"></div>
    </section>

    <!-- Calculator Suite -->
    <section id="panel-calc" class="panel hidden">
      <div class="card">
        <h3>Weightâ€‘Based Dose Calculator</h3>
        <div class="row">
          <div>
            <label class="hint">Medication</label>
            <select id="calc-med"></select>
          </div>
          <div>
            <label class="hint">Weight</label>
            <div class="row">
              <input id="wt" type="number" inputmode="decimal" placeholder="e.g. 70" />
              <select id="unit"><option value="kg">kg</option><option value="lb">lb</option></select>
            </div>
          </div>
        </div>
        <div class="row" style="margin-top:10px">
          <div>
            <label class="hint">mg/kg (override)</label>
            <input id="mgkg" type="number" inputmode="decimal" placeholder="auto from med" />
          </div>
          <div>
            <label class="hint">Max dose mg</label>
            <input id="maxmg" type="number" inputmode="decimal" placeholder="auto from med" />
          </div>
        </div>
        <div class="row" style="margin-top:10px">
          <div>
            <label class="hint">Concentration (mg/mL)</label>
            <input id="conc" type="number" inputmode="decimal" placeholder="e.g. 10" />
          </div>
          <div>
            <label class="hint">Route</label>
            <input id="route" type="text" placeholder="auto from med" />
          </div>
        </div>
        <div style="margin-top:12px" class="row">
          <button id="calc" class="btn primary">Calculate</button>
          <button id="reset" class="btn">Reset</button>
        </div>
        <div id="result" class="mono" style="margin-top:12px"></div>
      </div>

      <div class="card">
        <h3>Standard Dose â†’ Volume</h3>
        <p class="hint">(Dose ordered / Dose on hand) Ã— Volume on hand = mL to draw. Or use mg/mL directly.</p>
        <div class="row">
          <div>
            <label class="hint">Dose ordered</label>
            <input id="std-dose-ordered" type="number" inputmode="decimal" placeholder="e.g. 5" />
          </div>
          <div>
            <label class="hint">Dose on hand</label>
            <input id="std-dose-onhand" type="number" inputmode="decimal" placeholder="e.g. 10" />
          </div>
          <div>
            <label class="hint">Volume on hand (mL)</label>
            <input id="std-vol-onhand" type="number" inputmode="decimal" placeholder="e.g. 1" />
          </div>
        </div>
        <div class="row" style="margin-top:10px">
          <div>
            <label class="hint">OR: Concentration (mg/mL)</label>
            <input id="std-conc" type="number" inputmode="decimal" placeholder="e.g. 10" />
          </div>
          <div>
            <label class="hint">Result</label>
            <div id="std-result" class="mono" style="padding:12px;border:1px solid rgba(255,255,255,.12);border-radius:12px;min-height:44px"></div>
          </div>
        </div>
        <div style="margin-top:12px" class="row">
          <button id="std-calc" class="btn primary">Calculate</button>
          <button id="std-reset" class="btn">Reset</button>
        </div>
      </div>

      <div class="card">
        <h3>IV Infusion (mcg/kg/min â†’ gtts/min)</h3>
        <p class="hint">Enter ordered dose, weight, drug in bag (mg), bag volume (mL), and drip set (gtt/mL). Computes mL/hr and gtts/min.</p>
        <div class="row">
          <div>
            <label class="hint">Ordered (mcg/kg/min)</label>
            <input id="iv-ordered" type="number" inputmode="decimal" placeholder="e.g. 5" />
          </div>
          <div>
            <label class="hint">Weight</label>
            <div class="row">
              <input id="iv-wt" type="number" inputmode="decimal" placeholder="e.g. 70" />
              <select id="iv-unit"><option value="kg">kg</option><option value="lb">lb</option></select>
            </div>
          </div>
        </div>
        <div class="row" style="margin-top:10px">
          <div>
            <label class="hint">Drug in bag (mg)</label>
            <input id="iv-bagmg" type="number" inputmode="decimal" placeholder="e.g. 400" />
          </div>
          <div>
            <label class="hint">Bag volume (mL)</label>
            <input id="iv-bagvol" type="number" inputmode="decimal" placeholder="e.g. 250" />
          </div>
          <div>
            <label class="hint">Drip set (gtt/mL)</label>
            <input id="iv-dripset" type="number" inputmode="decimal" placeholder="10 / 15 / 20 / 60" />
          </div>
        </div>
        <div style="margin-top:12px" class="row">
          <button id="iv-calc" class="btn primary">Calculate</button>
          <button id="iv-reset" class="btn">Reset</button>
        </div>
        <div id="iv-result" class="mono" style="margin-top:12px"></div>
      </div>

      <div class="card">
        <h3>Manual Drip Timing</h3>
        <p class="hint">Target drops/min â†’ drops per 10 seconds (Ã·6).</p>
        <div class="row">
          <div>
            <label class="hint">Target (gtts/min)</label>
            <input id="md-target" type="number" inputmode="decimal" placeholder="e.g. 30" />
          </div>
          <div>
            <label class="hint">Result</label>
            <div id="md-result" class="mono" style="padding:12px;border:1px solid rgba(255,255,255,.12);border-radius:12px;min-height:44px"></div>
          </div>
        </div>
        <div style="margin-top:12px" class="row">
          <button id="md-calc" class="btn primary">Calculate</button>
          <button id="md-reset" class="btn">Reset</button>
        </div>
      </div>

      <div class="card">
        <h3>Fluid Over Time</h3>
        <p class="hint">Given volume, drip set, and time, compute gtts/min and mL/hr.</p>
        <div class="row">
          <div>
            <label class="hint">Volume (mL)</label>
            <input id="fo-volume" type="number" inputmode="decimal" placeholder="e.g. 1000" />
          </div>
          <div>
            <label class="hint">Drip set (gtt/mL)</label>
            <input id="fo-dripset" type="number" inputmode="decimal" placeholder="10 / 15 / 20 / 60" />
          </div>
          <div>
            <label class="hint">Time (min)</label>
            <input id="fo-time" type="number" inputmode="decimal" placeholder="e.g. 60" />
          </div>
        </div>
        <div style="margin-top:12px" class="row">
          <button id="fo-calc" class="btn primary">Calculate</button>
          <button id="fo-reset" class="btn">Reset</button>
        </div>
        <div id="fo-result" class="mono" style="margin-top:12px"></div>
      </div>

      <div class="card">
  <h3>Pump mL/hr â†’ Manual gtts/min</h3>
  <p class="hint">Formula: gtts/min = (mL/hr Ã— gtt/mL) Ã· 60. With 60-drop (microdrip), gtts/min = mL/hr.</p>
  <div class="row">
    <div>
      <label class="hint">Pump rate (mL/hr)</label>
      <input id="pump-rate" type="number" inputmode="decimal" placeholder="e.g. 120" />
    </div>
    <div>
      <label class="hint">Drip set (gtt/mL)</label>
      <input id="pump-dripset" type="number" inputmode="decimal" placeholder="10 / 15 / 20 / 60" />
    </div>
  </div>
  <div style="margin-top:12px" class="row">
    <button id="pump-calc" class="btn primary">Calculate</button>
    <button id="pump-reset" class="btn">Reset</button>
  </div>
  <div id="pump-result" class="mono" style="margin-top:12px"></div>
</div>

      <div class="card">
        <h3>APGAR Calculator</h3>
        <div class="row">
          <div>
            <label class="hint">Appearance</label>
            <select id="apgar-a"><option value="0">0: Blue/Pale</option><option value="1">1: Body pink, limbs blue</option><option value="2">2: Completely pink</option></select>
          </div>
          <div>
            <label class="hint">Pulse</label>
            <select id="apgar-p"><option value="0">0: Absent</option><option value="1">1: &lt;100</option><option value="2">2: â‰¥100</option></select>
          </div>
          <div>
            <label class="hint">Grimace</label>
            <select id="apgar-g"><option value="0">0: No response</option><option value="1">1: Grimace</option><option value="2">2: Cough/Sneeze/Cry</option></select>
          </div>
          <div>
            <label class="hint">Activity</label>
            <select id="apgar-ac"><option value="0">0: Limp</option><option value="1">1: Some flexion</option><option value="2">2: Active</option></select>
          </div>
          <div>
            <label class="hint">Respiration</label>
            <select id="apgar-r"><option value="0">0: Absent</option><option value="1">1: Slow/Irregular</option><option value="2">2: Good cry</option></select>
          </div>
        </div>
        <div style="margin-top:12px" class="row">
          <button id="apgar-calc" class="btn primary">Calculate</button>
          <button id="apgar-reset" class="btn">Reset</button>
        </div>
        <div id="apgar-result" class="mono" style="margin-top:12px"></div>
      </div>

      <div class="card">
        <h3>GCS Calculator</h3>
        <div class="row">
          <div>
            <label class="hint">Eye (E)</label>
            <select id="gcs-e"><option value="1">1: None</option><option value="2">2: To pain</option><option value="3">3: To voice</option><option value="4" selected>4: Spontaneous</option></select>
          </div>
          <div>
            <label class="hint">Verbal (V)</label>
            <select id="gcs-v"><option value="1">1: None</option><option value="2">2: Incomprehensible</option><option value="3">3: Inappropriate</option><option value="4">4: Confused</option><option value="5" selected>5: Oriented</option></select>
          </div>
          <div>
            <label class="hint">Motor (M)</label>
            <select id="gcs-m"><option value="1">1: None</option><option value="2">2: Extensor</option><option value="3">3: Flexor</option><option value="4">4: Withdraws</option><option value="5">5: Localizes</option><option value="6" selected>6: Obeys</option></select>
          </div>
        </div>
        <div style="margin-top:12px" class="row">
          <button id="gcs-calc" class="btn primary">Calculate</button>
          <button id="gcs-reset" class="btn">Reset</button>
        </div>
        <div id="gcs-result" class="mono" style="margin-top:12px"></div>
      </div>

      <div class="card">
        <h3>Oxygen Duration</h3>
        <div class="row">
          <div>
            <label class="hint">Cylinder</label>
            <select id="o2-cylinder">
              <option value="0.16">D (0.16)</option>
              <option value="0.28" selected>E (0.28)</option>
              <option value="1.56">M (1.56)</option>
              <option value="2.41">G (2.41)</option>
              <option value="3.14">H (3.14)</option>
            </select>
          </div>
          <div>
            <label class="hint">Pressure (psi)</label>
            <input id="o2-psi" type="number" inputmode="decimal" placeholder="e.g. 2000" />
          </div>
          <div>
            <label class="hint">Residual (psi)</label>
            <input id="o2-res" type="number" inputmode="decimal" value="200" />
          </div>
          <div>
            <label class="hint">Flow (L/min)</label>
            <input id="o2-flow" type="number" inputmode="decimal" placeholder="e.g. 15" />
          </div>
        </div>
        <div style="margin-top:12px" class="row">
          <button id="o2-calc" class="btn primary">Calculate</button>
          <button id="o2-reset" class="btn">Reset</button>
        </div>
        <div id="o2-result" class="mono" style="margin-top:12px"></div>
      </div>

      <div class="card">
        <h3>Vent Settings (IBW & TV)</h3>
        <p class="hint">Quick tidal volume planner using IBW (Devine). Always follow clinical judgment & protocols.</p>
        <div class="row">
          <div>
            <label class="hint">Sex</label>
            <select id="vent-sex"><option value="male">Male</option><option value="female">Female</option></select>
          </div>
          <div>
            <label class="hint">Height</label>
            <div class="row">
              <input id="vent-height" type="number" inputmode="decimal" placeholder="e.g. 70" />
              <select id="vent-hunit"><option value="in">in</option><option value="cm">cm</option></select>
            </div>
          </div>
        </div>
        <div style="margin-top:12px" class="row">
          <button id="vent-calc" class="btn primary">Calculate</button>
          <button id="vent-reset" class="btn">Reset</button>
        </div>
        <div id="vent-result" class="mono" style="margin-top:12px"></div>
      </div>

      <div class="card">
        <h3>Import / Export</h3>
        <p class="hint">Edit JSON for the <b>current service</b> below. Use "Save Service" to commit. You can also Export/Import the current service, or Export/Import <i>All Services</i>.</p>
        <div class="row" style="margin-bottom:8px">
          <button id="save-json" class="btn">Save Service</button>
          <button id="export-json" class="btn">Export Service</button>
          <input id="import-file" type="file" accept="application/json" class="btn" />
        </div>
        <div class="row">
          <button id="export-all" class="btn">Export All Services</button>
          <input id="import-all-file" type="file" accept="application/json" class="btn" />
        </div>
        <textarea id="json" rows="12" style="width:100%;margin-top:10px;border-radius:12px;padding:12px;background:#0f131a;color:var(--text);border:1px solid rgba(255,255,255,.12)"></textarea>
      </div>
    </section>

    <div class="footer">Offlineâ€‘friendly reference. Always follow your serviceâ€™s latest approved protocols.</div>
  </main>

  <script>
  // --- Multiâ€‘service client-side store ---
  const KEY = 'ems-protocols-multi-v1';
  const $ = sel => document.querySelector(sel);
  const $$ = sel => Array.from(document.querySelectorAll(sel));

  const SAMPLE_SERVICE = {
    protocols: [
  {
      id: 'adult-airway',
      title: 'Adult Airway (Intubation First Pass, Facilitated if needed)',
      summary: 'Oro/Nasotracheal; if failed first attempt â†’ consider ketamine-assisted intubation; confirm with EtCOâ‚‚ + second method; fallback SGA â†’ needle cric/BVM.',
      steps: [
        'Assess: unresponsive/apneic, gag, predicted difficulty; preoxygenate; suction as needed.',
        'Prepare: equipment check (laryngoscope/video, ET sizes, SGA backup, suction, BVM, capnography).',
        'Attempt orotracheal or nasotracheal intubation (1st pass).',
        'If unsuccessful: consider facilitated intubation (ketamine 2 mg/kg IV/IO).',
        'If still unsuccessful: place supraglottic airway; if failure â†’ needle cricothyrotomy and/or BVM.',
        'If intubated: confirm placement with EtCOâ‚‚ and an additional method (auscultation), secure tube.',
        'Reassess ventilation/oxygenation and document time, size, depth, confirmation method.'
      ],
      tags: ['airway','adult','intubation','ketamine','etco2','sga','cric']
    },

    {
      id: 'asystole-pea',
      title: 'Asystole / PEA',
      summary: 'Immediate CPR and epinephrine every 3â€“5 min; confirm rhythm; consider advanced airway.',
      steps: [
        'Immediate CPR.',
        'Cardiac Monitoring / Confirm Asystole or PEA.',
        'Establish IV/IO access.',
        'Administer Epinephrine 1:10,000 1 mg IV/IO every 3â€“5 minutes.',
        'Monitor for rhythm change every 2 minutes.',
        'Consider placement of an advanced airway.'
      ],
      tags: ['asystole','pea','cpr','epi','cardiac-arrest','adult']
    },
    {
      id: 'bradycardia',
      title: 'Bradycardia',
      summary: 'Treat symptomatic bradycardia; atropine first, then pacing or infusions as indicated.',
      steps: [
        'Cardiac monitoring.',
        'Establish IV/IO access.',
        'Administer Atropine 0.5â€“1 mg IV/IO every 5 minutes as needed.',
        'Apply defibrillator pads.',
        'Consider sedation with Versed (Midazolam) 1â€“5 mg IVP if pacing required.',
        'Begin transcutaneous pacing (TCP) at 70â€“80 BPM, 30 mA, increase output as needed.',
        'Consider Dopamine infusion 5â€“10 mcg/kg/min.',
        'Consider Epinephrine drip 2â€“10 mcg/min.'
      ],
      tags: ['bradycardia','atropine','pacing','dopamine','epi','versed']
    },
    {
      id: 'vfib-pulseless-vtach',
      title: 'Ventricular Fibrillation / Pulseless Ventricular Tachycardia',
      summary: 'Defibrillate early; give epinephrine every 3â€“5 min; amiodarone for refractory VF/VT.',
      steps: [
        'Attach ECG / Cardiac monitor.',
        'Begin CPR for 2 minutes.',
        'Establish advanced airway as needed.',
        'Defibrillate at 150 Joules, resume CPR immediately for 2 minutes.',
        'Establish IV/IO access.',
        'Administer Epinephrine 1:10,000 1 mg IV/IO every 3â€“5 minutes.',
        'Shock again at 150 Joules followed by 2 minutes of CPR.',
        'Administer Amiodarone 300 mg IVP, resume CPR for 2 minutes.',
        'Shock again at 150 Joules followed by 2 minutes of CPR.',
        'Administer second Amiodarone dose 150 mg IVP.',
        'Consider consulting OLMC for further management.'
      ],
      tags: ['vfib','vtach','arrest','amiodarone','epi','defib','adult']
    },
    {
      id: 'stable-narrow-tachycardia',
      title: 'Stable Narrow Complex Tachycardia (>150 BPM)',
      summary: 'Manage stable SVT with adenosine or diltiazem per protocol.',
      steps: [
        'Continuous ECG monitoring.',
        'Administer Adenosine 6 mg rapid IVP.',
        'If unresolved, administer Adenosine 12 mg rapid IVP.',
        'Consider Diltiazem (Cardizem) 20 mg slow IVP over 2 minutes for irregular AFib with RVR.'
      ],
      tags: ['svt','narrow-complex','adenosine','cardizem','afib','adult']
    },
    {
      id: 'unstable-narrow-tachycardia',
      title: 'Unstable Narrow Complex Tachycardia (>150 BPM)',
      summary: 'For unstable SVT or AFib, sedate if able and cardiovert.',
      steps: [
        'Consider sedation with Versed (Midazolam) 1â€“5 mg IVP.',
        'Synchronized cardioversion at 100â€“250 Joules.'
      ],
      tags: ['unstable','narrow-complex','svt','cardioversion','versed','adult']
    },

{
  id: 'stable-wide-tachycardia',
  title: 'Stable Adult Wide Complex Tachycardia',
  summary: 'Treat stable wide-complex tachycardia (VT) with antiarrhythmics and synchronized cardioversion if refractory.',
  steps: [
    'Administer Adenosine 12 mg rapid IVP.',
    'Administer Amiodarone 150 mg over 10 minutes.',
    'Consider sedation with Versed (Midazolam) 2â€“10 mg IVP.',
    'Perform synchronized cardioversion at 100 Joules if needed.',
    'If successfully converted, begin Amiodarone drip 150 mg over 10 minutes.'
  ],
  tags: ['wide-complex','tachycardia','amiodarone','adenosine','versed','cardioversion','adult']
},
{
  id: 'unstable-wide-tachycardia',
  title: 'Unstable Adult Wide Complex Tachycardia',
  summary: 'For unstable VT with pulse, prioritize synchronized cardioversion; consider Amiodarone drip after conversion.',
  steps: [
    'If critical, perform synchronized cardioversion at 200 Joules immediately.',
    'Otherwise, perform cardioversion at 100â€“200 Joules as indicated.',
    'Administer Amiodarone drip 150 mg over 10 minutes.',
    'If still unstable, repeat synchronized cardioversion at 200 Joules.'
  ],
  tags: ['unstable','wide-complex','vtach','cardioversion','amiodarone','adult']
},
{
  id: 'post-resuscitation',
  title: 'Post-Resuscitation Care',
  summary: 'Support airway, breathing, and circulation after ROSC; consider antiarrhythmic infusion and monitoring.',
  steps: [
    'Continue ventilatory support with 100% oxygen.',
    'Consider establishing a second IV line.',
    'Initiate continuous cardiac monitoring.',
    'Monitor and record vital signs frequently.',
    'If converted with defibrillation or medication, start Amiodarone drip 150 mg over 10 minutes.'
  ],
  tags: ['rosc','post-resuscitation','amiodarone','monitoring','oxygen','adult']
},
{
  id: 'acute-abdominal-pain-nausea',
  title: 'Acute Abdominal Pain & Nausea/Vomiting',
  summary: 'Assess and manage abdominal pain with monitoring and supportive care; treat nausea and pain per protocol.',
  steps: [
    'Initiate cardiac monitoring.',
    'Obtain a 12-lead EKG.',
    'Establish IV/IO access.',
    'Administer Zofran (Ondansetron) 4 mg for nausea.',
    'For pain, administer Morphine 2â€“10 mg IV or Dilaudid 0.25â€“1 mg IV.'
  ],
  tags: ['abdominal-pain','nausea','vomiting','zofran','morphine','dilaudid','adult']
},
{
  id: 'acute-coronary-syndrome',
  title: 'Acute Coronary Syndrome (ACS)',
  summary: 'Rapid recognition and treatment of suspected ACS including ASA, nitro, and pain management.',
  steps: [
    'Initiate cardiac monitoring.',
    'Obtain a 12-lead EKG.',
    'Administer Aspirin 324 mg PO (4Ã—81 mg).',
    'Establish IV/IO access.',
    'If pain and SBP >100 mmHg, give Nitroglycerin 0.4 mg SL every 5 min (max 3 doses).',
    'Consider Morphine 2â€“10 mg IV for persistent pain.',
    'If STEMI identified, consider aeromedical or transport to PCI-capable facility.'
  ],
  tags: ['acs','chest-pain','stemi','nitro','asa','morphine','cardiac','adult']
},
{
  id: 'mild-allergic-reaction',
  title: 'Allergic Reaction (Mild)',
  summary: 'Treat allergic reactions with fluids and antihistamines; escalate to anaphylaxis protocol if needed.',
  steps: [
    'Establish IV access.',
    'Administer Normal Saline 1 L bolus as needed.',
    'Administer Diphenhydramine (Benadryl) 25â€“50 mg IV/IM.'
  ],
  tags: ['allergic-reaction','benadryl','fluids','adult']
},
{
  id: 'severe-allergic-reaction',
  title: 'Allergic Reaction (Severe)',
  summary: 'Treat allergic reactions with fluids and antihistamines; escalate to anaphylaxis protocol if needed.',
  steps: [
    'Epinephrine 1:1 0.3-0.5 mg IM.',
    'Cardiac Monitoring.',
    'IV Procedure NS 1 L'
    'Benadryl 25-50 mg'
    'Inhaled Beta Agonist'
    'Solu-Medrol 125 mg'
  ],
  tags: ['allergic-reaction','benadryl','fluids','adult','solu-medrol']
},
{
  id: 'moderate-allergic-reaction',
  title: 'Allergic Reaction (Moderate)',
  summary: 'Treat allergic reactions with fluids and antihistamines; escalate to anaphylaxis protocol if needed.',
  steps: [
    'IV Procedure NS 1 L.',
    'Benadryl 25-50 mg',
    'Albuterol 2.5 mg nebulized'
    'Atrovent 0.5 mg nebulized'
    'Solu-Medrol 125 mg'
  ],
  tags: ['allergic-reaction','benadryl','fluids','adult','benadryl','albuterol','atrovent', 'solu-medrol']
},

{
  id: 'altered-mental-status',
  title: 'Altered Mental Status (Adult)',
  summary: 'Monitor, check ECG and glucose, secure access, consider Narcan.',
  steps: [
    'Initiate cardiac monitoring.',
    'Obtain a 12-lead EKG.',
    'Establish IV/IO access.',
    'Consider Narcan (Naloxone) 0.25â€“2 mg.'
  ],
  tags: ['ams','altered','naloxone','cardiac-monitoring','ivio','adult']
},
{
  id: 'behavioral-emergency',
  title: 'Behavioral Emergency',
  summary: 'Sedation as indicated for safety and care.',
  steps: [
    'Administer Versed (Midazolam) 1â€“5 mg.',
    'And/or administer Haldol (Haloperidol) 5 mg.'
  ],
  tags: ['behavioral','agitation','versed','haldol','adult']
},
{
  id: 'pulmonary-edema',
  title: 'Pulmonary Edema',
  summary: 'Treat afterload/preload; consider pressors if hypotensive; support ventilation.',
  steps: [
    'If SBP < 100 mmHg, consider Dopamine 5â€“10 mcg/kg/min.',
    'Administer Nitroglycerin 0.4 mg SL every 3â€“5 minutes (max 3) unless SBP < 100 mmHg.',
    'Establish IV/IO access.',
    'Consider CPAP.',
    'Administer Lasix (Furosemide) 20â€“80 mg.'
  ],
  tags: ['pulmonary-edema','nitro','dopamine','cpap','lasix','adult']
},
{
  id: 'diabetic-emergency',
  title: 'Diabetic Emergency',
  summary: 'Check glucose, give oral glucose if able; IV dextrose or D10W; fluids if DKA suspected.',
  steps: [
    'Initiate cardiac monitoring.',
    'Check blood glucose.',
    'If alert, give Oral Glucose.',
    'Establish IV/IO access.',
    'Administer D50W 25 g IV/IO.',
    'Administer D10W 250 mL.',
    'NS wide open if signs & symptoms of DKA.',
    'Obtain a 12-lead ECG.'
  ],
  tags: ['diabetic','hypoglycemia','dextrose','oral-glucose','dka','adult']
},
{
  id: 'drug-overdose-intoxication',
  title: 'Drug Overdose / Acute Intoxication',
  summary: 'Monitor, check glucose, support ABCs; targeted antidotes/therapies per suspected agent.',
  steps: [
    'Initiate cardiac monitoring.',
    'Establish IV/IO access.',
    'Perform blood glucose procedure.',
    'Administer Narcan 0.4 mg if opiate overdose suspected.',
    'Administer Normal Saline 1 L bolus if alcohol intoxication suspected.',
    'Administer Atropine 2â€“4 mg if organophosphate poisoning suspected.',
    'Begin Sodium Bicarbonate: 1 amp in 1 L NS infusion if TCA/Phenobarbital poisoning suspected.'
  ],
  tags: ['overdose','intoxication','naloxone','atropine','sodium-bicarb','adult']
},
{
  id: 'hypertensive-emergency',
  title: 'Hypertensive Emergency',
  summary: 'Confirm pressures bilaterally; initiate IV access; treat with antihypertensives per protocol.',
  steps: [
    'Initiate cardiac monitoring.',
    'Obtain a 12-lead EKG.',
    'Manual blood pressure in both arms.',
    'Establish IV/IO access.',
    'Administer Labetalol 20 mg or HCTZ 20 mg.',
    'Consider Nitroglycerin 0.4 mg SL.'
  ],
  tags: ['hypertension','labetalol','hctz','nitro','cardiac-monitoring','adult']
},
{
  id: 'heat-related-emergency',
  title: 'Heat Related Emergency',
  summary: 'Cool, monitor, hydrate; treat seizures with benzodiazepine.',
  steps: [
    'Assess patient temperature.',
    'Remove patient from heat source.',
    'Apply cold packs to pulse-point areas.',
    'Initiate cardiac monitoring.',
    'Establish IV/IO access.',
    'Normal Saline infusion 1â€“2 liters.',
    'Consider Versed (Midazolam) 1â€“5 mg for seizures.'
  ],
  tags: ['heat','hyperthermia','cooling','fluids','versed','adult']
},
{
  id: 'labor-delivery',
  title: 'Labor / Delivery',
  summary: 'Position, assess for crowning, avoid internal exams; follow newborn protocol when indicated.',
  steps: [
    'Place patient in left lateral recumbent (LLR) position.',
    'Inspect perineum; no digital exam.',
    'Initiate cardiac monitoring.',
    'Establish IV/IO access.',
    'If no crowning: monitor, reassess, document contractions.',
    'If crowning and â‰¥ 36 weeks gestation: follow Newborn Protocol.',
    'If abnormal presentation: immediate transport.'
  ],
  tags: ['ob','labor','delivery','newborn','obstetrics','adult']
},
{
  id: 'adult-pain-management',
  title: 'Adult Pain Management',
  summary: 'Analgesia and antiemetic as indicated.',
  steps: [
    'Initiate cardiac monitoring.',
    'Establish IV/IO access.',
    '>50 kg: Acetaminophen 1,000 mg IV over 15 minutes.',
    'Administer Morphine 2â€“10 mg IV or Dilaudid 0.25â€“1 mg IV.',
    'Consider Zofran (Ondansetron) 4 mg.'
  ],
  tags: ['pain','analgesia','tylenol','morphine','dilaudid','zofran','adult']
},
{
  id: 'pediatric-pain-management',
  title: 'Pediatric Pain Management',
  summary: 'Weight-based analgesia; antiemetic dosing by age/weight.',
  steps: [
    'Initiate cardiac monitoring.',
    'Establish IV/IO access.',
    'Acetaminophen <50 kg: 15 mg/kg IV over 15 minutes.',
    'Morphine 0.1 mg/kg.',
    'Consider Zofran (Ondansetron) 0.1 mg/kg if under 12 years.'
  ],
  tags: ['pediatric','pain','analgesia','tylenol','morphine','zofran']
}
  
  ],
 meds: [
  { name: "Aspirin", route: "PO", notes: "324 mg PO (4Ã—81 mg) for ACS.", contra: "Allergy, active GI bleed", se: "GI upset, tinnitus" },
  { name: "Adenosine", route: "IV", notes: "6â€“12 mg IV; may repeat 12 mg if no response.", contra: "2Â°/3Â° AV block, sick sinus (no pacer), asthma caution", se: "Transient asystole, flushing, chest pressure" },
  { name: "Amiodarone (VF/VT arrest)", route: "IV", notes: "300 mg IV; may repeat 150 mg Ã—1 for VFib/Pulseless VT.", contra: "Bradycardia, 2Â°/3Â° AV block", se: "Hypotension, bradycardia" },
  { name: "Amiodarone Infusion", route: "IV infusion", notes: "150 mg in 50â€“100 mL NS for VT with pulse; post-ROSC if amio given.", contra: "Bradycardia, 2Â°/3Â° AV block", se: "Hypotension, bradycardia" },
  { name: "Atropine", route: "IV", notes: "0.5â€“1 mg IV for bradycardia; may repeat once.", contra: "None in emergency; glaucoma caution", se: "Tachycardia, dry mouth" },
  { name: "Albuterol", route: "Neb", notes: "2.5 mg nebulized.", contra: "Hypersensitivity", se: "Tremor, tachycardia" },
  { name: "Ipratropium (Atrovent)", route: "Neb", notes: "0.5 mg nebulized.", contra: "Allergy to med; soy/peanut (older prep) caution", se: "Dry mouth, tachycardia" },
  { name: "Diphenhydramine (Benadryl)", route: "IM/slow IVP", notes: "25â€“50 mg for allergic reaction.", contra: "Newborns, glaucoma", se: "Drowsiness, hypotension" },
  { name: "Calcium Chloride", route: "IV", notes: "1 g IV for suspected hyperkalemia arrest; 500 mg for CCB overdose.", contra: "VF, digoxin toxicity", se: "Extravasation necrosis, bradycardia" },
  { name: "Diltiazem (Cardizem)", route: "SIVP", notes: "10â€“20 mg slow IVP for AFib w/ RVR; may repeat 25 mg after 15 min if BP stable.", contra: "Hypotension, wide-complex/VT, WPW w/ AF", se: "Hypotension, bradycardia" },
  { name: "Dextrose 5%", route: "IV", notes: "250 mL bag to mix medication (carrier).", contra: "None", se: "Irritation if extravasated" },
  { name: "Dextrose 10%", route: "IV", notes: "25 g (in 250 mL) IV for hypoglycemia.", contra: "Hyperglycemia", se: "Phlebitis, tissue injury if extravasated" },
  { name: "Hydromorphone (Dilaudid)", route: "IM/IV", notes: "0.25â€“1 mg for pain control.", contra: "Resp depression, hypotension", se: "Resp depression, nausea" },
  { name: "Dopamine", route: "IV infusion", notes: "2â€“20 mcg/kg/min for cardiogenic or septic shock with hypotension.", contra: "Uncorrected hypovolemia", se: "Tachycardia, hypertension, arrhythmias" },
  { name: "DuoNeb (Albuterol/Ipratropium)", route: "Neb", notes: "3 mg nebulized.", contra: "Hypersensitivity", se: "Tremor, dry mouth" },
  { name: "Epinephrine 1:1 (verify conc/route)", route: "IV", notes: "Listed: 1 mg IV q3â€“5 min for cardiac arrest (verify against local protocol).", contra: "None in arrest", se: "Tachycardia, anxiety, tremor" },
  { name: "Epinephrine 1:10 (verify conc/route)", route: "IM/Neb/IV infusion", notes: "0.3â€“0.5 mg IM anaphylaxis; 3â€“5 mg neb refractory airway; 2â€“10 mcg/min shock (verify).", contra: "Tachydysrhythmias, severe HTN (relative)", se: "Palpitations, tremor" },
  { name: "Furosemide", route: "IV", notes: "20â€“80 mg IV for CHF.", contra: "Hypovolemia, sulfa allergy caution", se: "Hypotension, hypokalemia" },
  { name: "Glucagon", route: "IM", notes: "1 mg IM for hypoglycemia.", contra: "Pheochromocytoma", se: "Nausea, vomiting" },
  { name: "Haloperidol (Haldol)", route: "IM", notes: "5 mg IM for moderate agitation.", contra: "Parkinson disease, seizure disorder", se: "EPS, hypotension" },
  { name: "Hydralazine", route: "Slow IVP", notes: "10â€“20 mg slow IVP for hypertension.", contra: "Hypotension, CAD", se: "Reflex tachycardia, headache" },
  { name: "Ketamine (intubation)", route: "IV/IO", default_mgkg: 2, notes: "2 mg/kg for facilitated intubation.", contra: "Severe HTN (relative), conditions worsened by â†‘ICP (controversial)", se: "â†‘HR/BP, emergence" },
  { name: "Ketamine (analgesia per med control)", route: "IV/IO", default_mgkg: 0.25, notes: "0.25 mg/kg for pain per medical control.", contra: "Severe HTN (relative)", se: "Dysphoria, nausea" },
  { name: "Labetalol", route: "Slow IVP", notes: "10â€“20 mg slow IVP for hypertension.", contra: "Bradycardia, asthma/COPD, CHF", se: "Hypotension, bradycardia" },
  { name: "Lidocaine (IO pain)", route: "IO", notes: "20â€“40 mg IO to reduce pain during IO infusion.", contra: "2Â°/3Â° AV block, severe SA dysfunction", se: "Drowsiness, confusion" },
  { name: "Magnesium Sulfate", route: "IV/IV infusion", notes: "1â€“2 g IV for torsades; 2â€“4 g/hr infusion for eclampsia.", contra: "Heart block, renal failure", se: "Flushing, hypotension" },
  { name: "Morphine", route: "IV", notes: "2â€“10 mg for pain control or inferior STEMI; Pediatric 0.1 mg/kg.", contra: "Hypotension, resp depression", se: "Hypotension, N/V" },
  { name: "Naloxone (Narcan)", route: "IV/IM/IN", notes: "0.4â€“2 mg; Pediatric 0.1 mg/kg.", contra: "Hypersensitivity", se: "Withdrawal, agitation" },

  { name: "Nitroglycerin", route: "SL", notes: "0.4 mg SL for ACS; repeat as needed. May use in CHF; hypertension per MC.", contra: "Hypotension, RV infarct, PDE-5 use", se: "Headache, hypotension" },
  { name: "Oral Glucose", route: "PO", notes: "15 g PO for hypoglycemia (if able to protect airway).", contra: "â†“LOC without gag", se: "Nausea" },
  { name: "Sodium Bicarbonate", route: "IV", notes: "50 mEq for cardiac arrest and crush injury (per protocol).", contra: "Alkalosis", se: "Alkalosis, hypernatremia" },
  { name: "Methylprednisolone (Solu-Medrol)", route: "IV/IM", notes: "125 mg IV/IM.", contra: "None in emergency", se: "Hyperglycemia" },
  { name: "Thiamine", route: "Slow IVP", notes: "25â€“100 mg SIVP for alcohol use/withdrawal.", contra: "None in emergency", se: "Rare hypotension" },
  { name: "Tranexamic Acid (TXA)", route: "Slow IVP/Infusion", notes: "2 g slow IVP or in 50â€“100 mL NS for suspected internal bleeding.", contra: "Active intravascular clotting, SAH", se: "Nausea, hypotension if pushed fast" },
  { name: "Midazolam (Versed)", route: "IV/IM/IN", notes: "1â€“5 mg; may repeat Ã—1 for seizures, facilitated intubation, psychosis.", contra: "Hypotension, resp depression", se: "Apnea, hypotension" },
  { name: "Verapamil", route: "SIVP", notes: "2.5â€“10 mg SIVP for AFib with RVR.", contra: "Hypotension, WPW w/ AF, wide-complex/VT", se: "Hypotension, bradycardia" },
  { name: "Ondansetron (Zofran)", route: "IV/IM/PO", notes: "4â€“8 mg for nausea.", contra: "Hypersensitivity; QT prolongation caution", se: "Headache, constipation" },
  { name: "Acetaminophen (Tylenol)", route: "IV", notes: ">50 kg: 1,000 mg IV over 15 min; <50 kg: 15 mg/kg IV over 15 min.", contra: "Severe liver disease", se: "Nausea, rash" }
]
  };

  const SAMPLE = {
    currentService: 'EASI AMBULANCE',
    services: {
      'EASI AMBULANCE': JSON.parse(JSON.stringify(SAMPLE_SERVICE))
    }
  };

  function load(){ try{ return JSON.parse(localStorage.getItem(KEY)) || SAMPLE }catch(e){ return SAMPLE } }
  function save(data){ localStorage.setItem(KEY, JSON.stringify(data)); }

  let state = load();

  // --- Helpers ---
  const protocolsEl = $('#protocols');
  const medsEl = $('#meds');
  const jsonEl = $('#json');
  const serviceSelect = $('#service-select');

  function svc(){ return state.services[state.currentService] }

  function highlight(text, terms){
    if(!terms.length) return text;
    let t = String(text||'');
    terms.forEach(w=>{ const re = new RegExp('('+escapeRegExp(w)+')','ig'); t = t.replace(re,'<mark>$1</mark>') });
    return t;
  }
  function escapeRegExp(s){ return String(s).replace(/[.*+?^${}()|[\]\\]/g, '\\$&') }

  function renderServiceSelect(){
    const names = Object.keys(state.services);
    serviceSelect.innerHTML = names.map(n=>`<option ${n===state.currentService?'selected':''}>${n}</option>`).join('');
  }

  function renderProtocols(filterTerms=[]){
    const items = (svc().protocols||[]).filter(p=> matchItem(p, filterTerms));
    protocolsEl.innerHTML = items.map(p=> `
      <div class="card">
        <h3>${highlight(p.title, filterTerms)}</h3>
        <div class="hint">${highlight(p.summary||'', filterTerms)}</div>
        <div style="margin-top:8px">
          ${(p.steps||[]).map((s,i)=>`<div><span class="k">${i+1}</span> ${highlight(s, filterTerms)}</div>`).join('')}
        </div>
        <div>${(p.tags||[]).map(t=>`<span class="tag">${t}</span>`).join('')}</div>
      </div>
    `).join('') || emptyState('No protocol matches');
  }

  function renderMeds(filterTerms=[]){
    const items = (svc().meds||[]).filter(m=> matchItem(m, filterTerms));
    medsEl.innerHTML = items.map(m=> `
      <div class="card">
        <h3>${highlight(m.name, filterTerms)} ${m.route?`<span class=\"badge\">${m.route}</span>`:''}</h3>
        <div class="hint">${highlight(m.notes||'', filterTerms)}</div>
        <div style="margin-top:8px" class="row">
          <button class="btn" onclick="loadIntoCalc('${(m.name||'').replace(/'/g, "&#39;")}')">Send to Calculator</button>
          ${typeof m.default_mgkg!=='undefined' && m.default_mgkg!==null ? `<span class=\"pill\"><span class=\"k\">mg/kg</span>${m.default_mgkg}</span>`:''}
        </div>
      </div>
    `).join('') || emptyState('No medication matches');
  }

  function emptyState(msg){ return `<div class=\"card\">${msg}</div>` }

  function matchItem(obj, terms){
    if(!terms.length) return true;
    const hay = (Object.values(obj).join(' ') + ' ' + (obj.tags||[]).join(' ')).toLowerCase();
    return terms.every(t => hay.includes(t));
  }

  function renderAll(terms){
    renderServiceSelect();
    renderProtocols(terms);
    renderMeds(terms);
    renderCalcOptions();
    jsonEl.value = JSON.stringify(svc(), null, 2);
  }

  // --- Search ---
  const q = $('#q');
  let deb;
  q.addEventListener('input', ()=>{
    clearTimeout(deb);
    deb = setTimeout(()=>{
      const terms = q.value.trim().toLowerCase().split(/\s+/).filter(Boolean);
      renderAll(terms);
    }, 80);
  });

  // --- Tabs ---
  $$('.tab').forEach(btn=> btn.addEventListener('click', ()=>{
    $$('.tab').forEach(b=> b.classList.remove('active'));
    btn.classList.add('active');
    const tab = btn.dataset.tab;
    $$('.panel').forEach(p=> p.classList.add('hidden'));
    $('#panel-'+tab).classList.remove('hidden');
  }));

  // --- Services Management ---
  serviceSelect.addEventListener('change', ()=>{
    state.currentService = serviceSelect.value;
    save(state);
    renderAll(q.value.trim().toLowerCase().split(/\s+/).filter(Boolean));
  });

  $('#add-service').addEventListener('click', ()=>{
    const name = prompt('New service name?');
    if(!name) return;
    if(state.services[name]) return alert('Name already exists.');
    state.services[name] = JSON.parse(JSON.stringify(SAMPLE_SERVICE));
    state.currentService = name;
    save(state);
    renderAll([]);
  });

  $('#rename-service').addEventListener('click', ()=>{
    const old = state.currentService;
    const name = prompt('Rename service to:', old);
    if(!name || name===old) return;
    if(state.services[name]) return alert('Name already exists.');
    state.services[name] = state.services[old];
    delete state.services[old];
    state.currentService = name;
    save(state);
    renderAll([]);
  });

  $('#duplicate-service').addEventListener('click', ()=>{
    const from = state.currentService;
    const name = prompt('Duplicate service as:', from+' Copy');
    if(!name) return;
    if(state.services[name]) return alert('Name already exists.');
    state.services[name] = JSON.parse(JSON.stringify(state.services[from]));
    state.currentService = name;
    save(state);
    renderAll([]);
  });

  $('#delete-service').addEventListener('click', ()=>{
    const name = state.currentService;
    if(Object.keys(state.services).length===1) return alert('Keep at least one service.');
    if(confirm(`Delete "${name}"? This cannot be undone.`)){
      delete state.services[name];
      state.currentService = Object.keys(state.services)[0];
      save(state);
      renderAll([]);
    }
  });

  // --- Calculators ---
  function kg(val, unit){ return unit==='lb' ? (val/2.20462) : val }
  function toKg(val, unit){ return kg(val, unit) }
  function fmt(n, d=1){ if(!isFinite(n)) return 'â€”'; return Number(n).toFixed(d) }
  function hhmm(min){ if(!isFinite(min)) return 'â€”'; const h=Math.floor(min/60), m=Math.round(min%60); return `${h}h ${m}m` }

  function renderCalcOptions(){
    const sel = $('#calc-med');
    const meds = (svc().meds||[]);
    sel.innerHTML = '<option value="">â€” choose â€”</option>' + meds.map(m=>`<option value="${m.name}">${m.name}</option>`).join('');
  }
  function loadIntoCalc(name){
    const m = (svc().meds||[]).find(x=>x.name===name);
    if(!m) return;
    $('#calc-med').value = m.name;
    $('#mgkg').value = (m.default_mgkg ?? '');
    $('#maxmg').value = (m.max_mg ?? '');
    $('#route').value = m.route||'';
    document.querySelector('[data-tab="calc"]').click();
  }
  window.loadIntoCalc = loadIntoCalc;

  $('#calc').addEventListener('click', ()=>{
    const medName = $('#calc-med').value;
    const m = (svc().meds||[]).find(x=>x.name===medName);
    if(!m){ $('#result').innerHTML = 'Select a medication.'; return }
    const wt = parseFloat($('#wt').value||'0');
    const unit = $('#unit').value;
    const mgkg = parseFloat($('#mgkg').value||m.default_mgkg||0);
    const maxmg = parseFloat($('#maxmg').value||m.max_mg||Infinity);
    const conc = parseFloat($('#conc').value||'0');
    if(!wt || !mgkg){ $('#result').innerHTML = 'Enter weight and mg/kg.'; return }
    const weightKg = kg(wt, unit);
    let dose = weightKg * mgkg; // mg
    if(isFinite(maxmg)) dose = Math.min(dose, maxmg);
    const mL = conc ? (dose/conc) : null;
    $('#result').innerHTML = `
      <div>Medication: <b>${medName}</b> (${m?.route||$('#route').value||''})</div>
      <div>Weight used: <b>${weightKg.toFixed(1)} kg</b> ${unit==='lb'?`(${wt} lb)`:''}</div>
      <div>Total dose: <b>${dose.toFixed(1)} mg</b>${isFinite(maxmg)?` (max ${maxmg} mg)`:''}</div>
      ${mL!==null?`<div>Volume to draw: <b>${mL.toFixed(2)} mL</b> @ ${conc} mg/mL</div>`:''}
    `;
  });

  $('#reset').addEventListener('click', ()=>{
    ['wt','mgkg','maxmg','conc','route'].forEach(id=> $('#'+id).value='');
    $('#calc-med').value='';
    $('#result').innerHTML='';
  });


// Pump mL/hr â†’ Manual gtts/min
document.querySelector('#pump-calc').addEventListener('click', ()=>{
  const rate = parseFloat(document.querySelector('#pump-rate').value || '0');      // mL/hr
  const drip = parseFloat(document.querySelector('#pump-dripset').value || '0');   // gtt/mL
  if(!(rate && drip)){
    document.querySelector('#pump-result').innerHTML = 'Enter pump rate and drip set.';
    return;
  }
  // gtts/min = (mL/hr Ã— gtt/mL) Ã· 60
  const gttsMin = (rate * drip) / 60;
  // Nice note for microdrip 60 gtt/mL
  const microNote = (Math.abs(drip - 60) < 1e-6) ? ' (60 gtt/mL â†’ equals mL/hr)' : '';
  document.querySelector('#pump-result').innerHTML =
    `Target manual rate: <b>${Math.round(gttsMin)}</b> gtts/min${microNote} (exact: ${Number(gttsMin).toFixed(1)})`;
});

document.querySelector('#pump-reset').addEventListener('click', ()=>{
  document.querySelector('#pump-rate').value = '';
  document.querySelector('#pump-dripset').value = '';
  document.querySelector('#pump-result').innerHTML = '';
});

  // Standard Dose â†’ Volume
  $('#std-calc').addEventListener('click', ()=>{
    const ordered = parseFloat($('#std-dose-ordered').value||'0');
    const onhand = parseFloat($('#std-dose-onhand').value||'0');
    const vol = parseFloat($('#std-vol-onhand').value||'0');
    const conc = parseFloat($('#std-conc').value||'0');
    let mL = NaN;
    if(ordered && onhand && vol){ mL = (ordered/onhand)*vol }
    else if(ordered && conc){ mL = ordered/conc }
    const txt = isFinite(mL) ? `Draw: <b>${fmt(mL,2)} mL</b>` : 'Enter ordered + onâ€‘hand + volume, or ordered + concentration.';
    $('#std-result').innerHTML = txt;
  });
  $('#std-reset').addEventListener('click', ()=>{ ['std-dose-ordered','std-dose-onhand','std-vol-onhand','std-conc'].forEach(id=> $('#'+id).value=''); $('#std-result').innerHTML=''; });

  // IV Infusion gtts/min
  $('#iv-calc').addEventListener('click', ()=>{
    const ordered = parseFloat($('#iv-ordered').value||'0'); // mcg/kg/min
    let wt = parseFloat($('#iv-wt').value||'0');
    wt = toKg(wt, $('#iv-unit').value);
    const bagmg = parseFloat($('#iv-bagmg').value||'0'); // mg in bag
    const bagvol = parseFloat($('#iv-bagvol').value||'0'); // mL
    const drip = parseFloat($('#iv-dripset').value||'0'); // gtt/mL
    if(!(ordered&&wt&&bagmg&&bagvol&&drip)){ $('#iv-result').innerHTML='Enter all fields.'; return }
    const mgPerMl = bagmg / bagvol; // mg/mL
    const mgPerHr = (ordered * wt * 60) / 1000; // mcgâ†’mg
    const mLhr = mgPerHr / mgPerMl;
    const gttsMin = (mLhr * drip) / 60;
    $('#iv-result').innerHTML = `mL/hr: <b>${fmt(mLhr,1)}</b> â€¢ gtts/min: <b>${Math.round(gttsMin)}</b>`;
  });
  $('#iv-reset').addEventListener('click', ()=>{ ['iv-ordered','iv-wt','iv-bagmg','iv-bagvol','iv-dripset'].forEach(id=> $('#'+id).value=''); $('#iv-result').innerHTML=''; });

  // Manual Drip Timing
  $('#md-calc').addEventListener('click', ()=>{
    const target = parseFloat($('#md-target').value||'0');
    if(!target){ $('#md-result').innerHTML='Enter a target gtts/min.'; return }
    const per10 = target/6;
    $('#md-result').innerHTML = `Aim ~<b>${Math.round(per10)}</b> gtts every 10 s (exact: ${fmt(per10,1)}).`;
  });
  $('#md-reset').addEventListener('click', ()=>{ $('#md-target').value=''; $('#md-result').innerHTML=''; });

  // Fluid Over Time
  $('#fo-calc').addEventListener('click', ()=>{
    const vol = parseFloat($('#fo-volume').value||'0');
    const drip = parseFloat($('#fo-dripset').value||'0');
    const time = parseFloat($('#fo-time').value||'0');
    if(!(vol&&drip&&time)){ $('#fo-result').innerHTML='Enter volume, drip set, and time.'; return }
    const gttsMin = (vol * drip) / time;
    const mLhr = (vol / time) * 60;
    $('#fo-result').innerHTML = `gtts/min: <b>${Math.round(gttsMin)}</b> â€¢ mL/hr: <b>${fmt(mLhr,0)}</b>`;
  });
  $('#fo-reset').addEventListener('click', ()=>{ ['fo-volume','fo-dripset','fo-time'].forEach(id=> $('#'+id).value=''); $('#fo-result').innerHTML=''; });

  // APGAR
  $('#apgar-calc').addEventListener('click', ()=>{
    const a = parseInt($('#apgar-a').value); const p = parseInt($('#apgar-p').value); const g = parseInt($('#apgar-g').value); const ac = parseInt($('#apgar-ac').value); const r = parseInt($('#apgar-r').value);
    const total = a+p+g+ac+r;
    const cat = total>=7? 'Normal (7â€“10)' : total>=4? 'Moderate (4â€“6)' : 'Low (0â€“3)';
    $('#apgar-result').innerHTML = `Score: <b>${total}</b> â€¢ ${cat}`;
  });
  $('#apgar-reset').addEventListener('click', ()=>{ ['apgar-a','apgar-p','apgar-g','apgar-ac','apgar-r'].forEach(id=> $('#'+id).selectedIndex=0); $('#apgar-result').innerHTML=''; });

  // GCS
  $('#gcs-calc').addEventListener('click', ()=>{
    const e = parseInt($('#gcs-e').value); const v = parseInt($('#gcs-v').value); const m = parseInt($('#gcs-m').value);
    const total = e+v+m;
    $('#gcs-result').innerHTML = `E${e} V${v} M${m} â€¢ Total: <b>${total}</b>`;
  });
  $('#gcs-reset').addEventListener('click', ()=>{ $('#gcs-e').selectedIndex=3; $('#gcs-v').selectedIndex=4; $('#gcs-m').selectedIndex=5; $('#gcs-result').innerHTML=''; });

  // Oxygen Duration
  $('#o2-calc').addEventListener('click', ()=>{
    const k = parseFloat($('#o2-cylinder').value||'0');
    const psi = parseFloat($('#o2-psi').value||'0');
    const res = parseFloat($('#o2-res').value||'0');
    const flow = parseFloat($('#o2-flow').value||'0');
    if(!(k&&psi&&flow)){ $('#o2-result').innerHTML='Enter cylinder, pressure, and flow.'; return }
    const min = ((psi - res) * k) / flow;
    $('#o2-result').innerHTML = `Duration: <b>${fmt(min,0)} min</b> (~${hhmm(min)})`;
  });
  $('#o2-reset').addEventListener('click', ()=>{ ['o2-psi','o2-flow'].forEach(id=> $('#'+id).value=''); $('#o2-res').value='200'; $('#o2-result').innerHTML=''; });

  // Vent Settings (IBW & TV)
  function inchesFrom(val, unit){ return unit==='cm' ? (val/2.54) : val }
  function ibwKg(sex, inches){ const over5ft = Math.max(0, inches - 60); return (sex==='male' ? 50 : 45.5) + 2.3*over5ft }
  $('#vent-calc').addEventListener('click', ()=>{
    const sex = $('#vent-sex').value;
    const h = parseFloat($('#vent-height').value||'0');
    const unit = $('#vent-hunit').value;
    if(!(sex&&h)){ $('#vent-result').innerHTML='Enter sex and height.'; return }
    const inches = inchesFrom(h, unit);
    const ibw = ibwKg(sex, inches);
    const tv6 = ibw*6, tv7 = ibw*7, tv8 = ibw*8; // mL
    $('#vent-result').innerHTML = `IBW: <b>${fmt(ibw,1)} kg</b> â€¢ TV @6: <b>${fmt(tv6,0)} mL</b> â€¢ @7: <b>${fmt(tv7,0)} mL</b> â€¢ @8: <b>${fmt(tv8,0)} mL</b>`;
  });
  $('#vent-reset').addEventListener('click', ()=>{ $('#vent-height').value=''; $('#vent-sex').selectedIndex=0; $('#vent-hunit').selectedIndex=0; $('#vent-result').innerHTML=''; });

  // Import/Export (perâ€‘service)
  $('#save-json').addEventListener('click', ()=>{ 
    try{ 
      const obj = JSON.parse(jsonEl.value);
      if(!obj || typeof obj!== 'object') throw new Error('Invalid JSON');
      state.services[state.currentService] = obj;
      save(state); 
      alert('Saved current service.'); 
      renderAll(q.value.trim().toLowerCase().split(/\s+/).filter(Boolean)); 
    }catch(e){ alert('Invalid JSON') } 
  });

  $('#export-json').addEventListener('click', ()=>{
    const name = state.currentService.replace(/[^a-z0-9-_ ]/gi,'_');
    const blob = new Blob([JSON.stringify(svc(),null,2)], {type:'application/json'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `ems-${name}.json`;
    a.click();
  });

  $('#import-file').addEventListener('change', async (e)=>{
    const file = e.target.files[0]; if(!file) return;
    const txt = await file.text();
    try{ 
      const obj = JSON.parse(txt); 
      state.services[state.currentService] = obj; 
      save(state); 
      jsonEl.value = JSON.stringify(svc(),null,2); 
      renderAll(q.value.trim().toLowerCase().split(/\s+/).filter(Boolean)); 
      alert('Imported JSON into current service.'); 
    }
    catch(err){ alert('Invalid JSON file.'); }
    finally{ e.target.value=''; }
  });

  // Import/Export (all services)
  $('#export-all').addEventListener('click', ()=>{
    const blob = new Blob([JSON.stringify(state,null,2)], {type:'application/json'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'ems-all-services.json';
    a.click();
  });

  $('#import-all-file').addEventListener('change', async (e)=>{
    const file = e.target.files[0]; if(!file) return;
    const txt = await file.text();
    try{ 
      const obj = JSON.parse(txt); 
      if(!obj.services || !obj.currentService) throw new Error('Not an all-services export');
      state = obj; 
      save(state); 
      renderAll(q.value.trim().toLowerCase().split(/\s+/).filter(Boolean)); 
      alert('Imported all services.'); 
    }
    catch(err){ alert('Invalid ALLâ€‘services JSON file.'); }
    finally{ e.target.value=''; }
  });

  // Init
  renderAll([]);
  </script>
</body>
</html>
